<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Twitch Regex Tool</title>
<style>
  :root{
    --max-w:700px;
    --accent:#ff9800;
    --twitch:#9146FF;
    --fossa:#3399ff;
    --bg:#0d0d0d;
    --glass-bg: rgba(255,255,255,0.05);
    --glass-border: rgba(255,255,255,0.12);
    --muted: rgba(200,200,200,0.5);
  }
  html,body{height:100%;margin:0;}
  body{
    font-family: Inter, system-ui, sans-serif;
    background: var(--bg);
    color: #f5f5f5;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:24px;
    gap:12px;
  }

  h1{
    font-size:2.1rem;
    margin:0;
    color:#fff;
    text-align:center;
    max-width:var(--max-w);
    width:100%;
  }

  /* Display boxes */
  .display-box{
    width:100%;
    max-width:var(--max-w);
    background: rgba(255,255,255,0.06);
    border-radius:12px;
    padding:10px 12px;
    display:flex;
    align-items:flex-start;
    gap:10px;
    font-family: monospace;
  }
  .label{
    flex:0 0 72px;
    color:var(--accent);
    font-weight:700;
    align-self:center;
  }
  .content{
    flex:1 1 auto;
    font-size:0.95rem; /* größer wie gewünscht */
    line-height:1.3;
    word-break:break-word;
    white-space:pre-wrap;
    cursor: default;
  }
  .display-box:hover{ box-shadow: 0 6px 18px rgba(0,0,0,0.4); }

  /* Grid of letter boxes */
  .grid{
    width:100%;
    max-width:var(--max-w);
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(88px, 1fr));
    gap:12px;
    margin-top:8px;
  }
  .box{
    background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    border:1px solid var(--glass-border);
    border-radius:14px;
    padding:10px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    cursor:pointer;
    transition: transform .12s ease, background .12s ease;
    height:56px; /* fixed height so boxes don't grow */
  }
  .box .letter{ font-weight:800; font-size:1.05rem; color:#fff; }
  .box .toggle{
    background: rgba(255,255,255,0.08);
    border: none;
    color:#fff;
    border-radius:8px;
    padding:6px 8px;
    cursor:pointer;
    font-weight:700;
    user-select:none;
  }
  .box:hover{ transform: translateY(-4px); }

  .toggle.active{ background: var(--accent); color:#111; }

  /* controls: left group (clear all/last) and right (test) */
  .controls{
    width:100%;
    max-width:var(--max-w);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
    margin-top:6px;
  }
  .controls .left{ display:flex; gap:10px; }
  button.main{
    background:var(--accent);
    border:none;
    padding:10px 16px;
    border-radius:12px;
    font-weight:800;
    color:#111;
    cursor:pointer;
    text-transform:uppercase;
  }
  button.main:hover{ filter:brightness(1.06); }

  /* Chatty + Fossabot boxes */
  .mode-box{
    width:100%;
    max-width:var(--max-w);
    display:flex;
    gap:12px;
    margin-top:12px;
  }
  .chatty-box, .fossabot-box{
    flex:1;
    padding:12px;
    border-radius:10px;
    border:2px solid;
    text-align:center;
    text-transform:uppercase;
    font-weight:800;
    cursor:pointer;
    position:relative;
    height:56px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
  }
  .chatty-box{ border-color: var(--twitch); color:var(--twitch); }
  .chatty-box.active{ background:var(--twitch); color:#111; }

  .fossabot-box{ border-color:var(--fossa); color:var(--fossa); flex-direction:column; justify-content:center; }
  .fossabot-box .main-label{ font-size:1.15rem; transition: transform .18s ease, font-size .18s ease; }
  .fossabot-box.active .main-label{ transform: translateY(-3px) scale(.95); font-size:1rem; }
  .fossabot-box .mode-label{ font-size:.72rem; opacity:0; transition:opacity .18s ease; }
  .fossabot-box.active .mode-label{ opacity:.9; }

  .fossabot-box .arrow{ position:absolute; right:14px; font-size:1.4rem; }

  /* dropdown */
  .dropdown{
    width:100%;
    max-width:var(--max-w);
    background: rgba(51,153,255,0.06);
    border-radius:8px;
    margin-top:8px;
    overflow:hidden;
    max-height:0;
    opacity:0;
    transition:all .22s ease;
  }
  .dropdown.open{ max-height:220px; opacity:1; padding:8px 0; }
  .dropdown div{ padding:10px 16px; cursor:pointer; color:#ddd; }
  .dropdown div:hover{ background: rgba(51,153,255,0.12); color:#fff; }

  /* Approved suggestions */
  .suggestions{
    width:100%;
    max-width:var(--max-w);
    margin-top:18px;
    background: rgba(255,255,255,0.03);
    border-radius:10px;
    padding:12px;
  }
  .suggestions h2{ margin:0 0 8px 0; color:var(--accent); }
  .suggestions-list{ display:flex; flex-direction:column; gap:6px; }
  .suggestion-item{
    font-family:monospace;
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    padding:8px;
    border-radius:6px;
    color:#ddd;
    word-break:break-word;
  }

  .watermark{
    margin-top:18px;
    font-family:monospace;
    color:var(--muted);
    text-align:center;
    width:100%;
    max-width:var(--max-w);
  }

  /* small responsive */
  @media (max-width:560px){
    .grid{ grid-template-columns: repeat(3,1fr); }
  }
</style>
</head>
<body>
  <h1>Twitch Regex Tool</h1>

  <div class="display-box" id="wordDisplay">
    <div class="label">Word:</div>
    <div class="content" id="wordContent"></div>
  </div>

  <div class="display-box" id="regexDisplay" title="Klicken zum Kopieren">
    <div class="label">Regex:</div>
    <div class="content" id="regexContent"></div>
  </div>

  <div class="grid" id="grid"></div>

  <div class="controls">
    <div class="left">
      <button class="main" id="clearAllBtn">CLEAR ALL</button>
      <button class="main" id="clearLastBtn">CLEAR LAST</button>
    </div>
    <div class="right">
      <button class="main" id="regexTestBtn">TEST REGEX</button>
    </div>
  </div>

  <div class="mode-box">
    <div class="chatty-box" id="chattyToggle">CHATTY</div>
    <div class="fossabot-box" id="fossabotToggle">
      <div class="main-label">FOSSABOT</div>
      <div class="mode-label" id="fossabotModeLabel"></div>
      <div class="arrow">›</div>
    </div>
  </div>

  <div class="dropdown" id="fossabotMenu">
    <div data-mode="standard">Standard</div>
    <div data-mode="keyword">Keyword</div>
    <div data-mode="blocked">Blocked Terms</div>
    <div data-mode="negative">Negativ</div>
  </div>

  <div class="suggestions">
    <h2>Approved Regex Vorschläge</h2>
    <div id="suggestionsList" class="suggestions-list"></div>
  </div>

  <div class="watermark">© 2025 – rewins / All Right Reserved</div>

  <!-- Firebase + App logic -->
  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCfUNk8o8i2JCWmVdbmquayf8mAzVfXssQ",
    authDomain: "twitch-regex-tool.firebaseapp.com",
    projectId: "twitch-regex-tool",
    storageBucket: "twitch-regex-tool.appspot.com",
    messagingSenderId: "445469176853",
    appId: "1:445469176853:web:94df70e3f8598a09068a1c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Regex mapping (inkl. ä,ö,ü,ß)
  const regexMap = {
    a: "[aA@4äÄàáâãåĀ#*]", b: "[bB8ßẞ#*]", c: "[cC(ķčćç¢©#*]",
    d: "[dDÐďđ#*]", e: "[eE3€èéêëě#*]", f: "[fFƒ#*]",
    g: "[gG6ɢ9#*]", h: "[hH#*]", i: "[iI1!|ìíîïįī#*]",
    j: "[jJ#*]", k: "[kKκ#*]", l: "[lL1!|ł#*]",
    m: "[mM#*]", n: "[nNñńňņ#*]", o: "[oO0öÖóòôõø¤°#*]",
    p: "[pPρ¶þ#*]", q: "[qQ9#*]", r: "[rRʁЯ®#*]",
    s: "[sS5$šśş§ßẞ#*]", t: "[tT7†ŧ#*]", u: "[uUúùûüÜūµ#*]",
    v: "[vV\\/#!*]", w: "[wWvvωŴ#*]", x: "[xX%×χ#*]",
    y: "[yY¥ýÿ#*]", z: "[zZ2žźżʒ#*]",
    ä: "[äA@4aA#*]", ö: "[öÖoO#*]", ü: "[üÜuU#*]", ß: "[ßẞ5$sS#*]"
  };

  // DOM refs
  const grid = document.getElementById("grid");
  const wordContent = document.getElementById("wordContent");
  const regexContent = document.getElementById("regexContent");
  const regexDisplay = document.getElementById("regexDisplay");
  const clearAllBtn = document.getElementById("clearAllBtn");
  const clearLastBtn = document.getElementById("clearLastBtn");
  const regexTestBtn = document.getElementById("regexTestBtn");
  const chattyToggle = document.getElementById("chattyToggle");
  const fossabotToggle = document.getElementById("fossabotToggle");
  const fossabotMenu = document.getElementById("fossabotMenu");
  const fossabotModeLabel = document.getElementById("fossabotModeLabel");
  const suggestionsList = document.getElementById("suggestionsList");

  const arrow = fossabotToggle.querySelector(".arrow");

  // state: keep arrays so CLEAR LAST is reliable
  let wordSegments = [];
  let regexSegments = [];
  let chattyMode = false;
  let fossabotMode = "standard"; // standard, keyword, blocked, negative

  function buildDisplayedRegex(){
    // join fragments
    const joined = regexSegments.join('');
    let prefix = "";
    if (fossabotMode === "keyword" || fossabotMode === "blocked") prefix = "regex:";
    if (fossabotMode === "negative") prefix = "regex:negative:";
    if (chattyMode) prefix = prefix + "config:any regi:";
    // final: (?i)(_|\b) + joined + (_|\b)
    return prefix + `(?i)(_|\\b)${joined}(_|\\b)`;
  }

  function updateDisplay(){
    wordContent.textContent = wordSegments.join('');
    regexContent.textContent = buildDisplayedRegex();
  }

  // Build grid with letter boxes + toggle
  Object.keys(regexMap).forEach(letter => {
    const container = document.createElement("div");
    container.className = "box";

    const span = document.createElement("div");
    span.className = "letter";
    span.textContent = letter;

    const toggleBtn = document.createElement("button");
    toggleBtn.className = "toggle";
    toggleBtn.textContent = "?";
    toggleBtn.dataset.optional = "false";

    container.appendChild(span);
    container.appendChild(toggleBtn);

    // click on letter area -> add segment
    container.addEventListener("click", (e) => {
      if (e.target === toggleBtn) return; // handled separately
      // add letter to word
      wordSegments.push(letter);

      const isOptional = toggleBtn.dataset.optional === "true";

      if (isOptional) {
        // when optional, add pattern like ( [chars]*? )
        regexSegments.push(`(${regexMap[letter]}*?)`);
        // reset toggle
        toggleBtn.dataset.optional = "false";
        toggleBtn.classList.remove("active");
      } else {
        // normal addition: [chars]+[\W_#*]*
        regexSegments.push(`${regexMap[letter]}+[\\W_#*]*`);
      }

      updateDisplay();
    });

    // toggle behaviour
    toggleBtn.addEventListener("click", (e) => {
      e.stopPropagation();
      const now = toggleBtn.dataset.optional === "true";
      toggleBtn.dataset.optional = now ? "false" : "true";
      toggleBtn.classList.toggle("active", !now);
    });

    grid.appendChild(container);
  });

  // Click regex line -> copy and save to Firestore
  regexDisplay.addEventListener("click", async () => {
    const displayText = regexContent.textContent || "";
    try {
      await navigator.clipboard.writeText(displayText);
      // Provide immediate feedback
      const prev = regexContent.textContent;
      regexContent.textContent = "Kopiert!";
      // Save to Firestore: store both display and raw (prefix-stripped)
      let raw = displayText
        .replace(/^config:any regi:/, '')
        .replace(/^regex:negative:/, '')
        .replace(/^regex:/, '')
        .trim();
      try {
        await addDoc(collection(db, "regex_submissions"), {
          display: displayText,
          raw: raw,
          createdAt: new Date()
        });
      } catch (e) {
        console.error("Fehler beim Speichern in Firestore:", e);
      }
      setTimeout(() => { updateDisplay(); }, 1000);
    } catch (err) {
      console.error("Kopieren fehlgeschlagen:", err);
    }
  });

  // Clear all
  clearAllBtn.addEventListener("click", () => {
    wordSegments = [];
    regexSegments = [];
    updateDisplay();
  });

  // Clear last (remove last segment reliably)
  clearLastBtn.addEventListener("click", () => {
    if (wordSegments.length === 0) return;
    wordSegments.pop();
    regexSegments.pop();
    updateDisplay();
  });

  // TEST REGEX -> open regex101 without site-only prefixes (strip config/regex)
  regexTestBtn.addEventListener("click", () => {
    let text = buildDisplayedRegex();
    // remove config/regex prefixes for regex101
    text = text.replace(/^config:any regi:/, '').replace(/^regex:negative:/, '').replace(/^regex:/, '').trim();
    const url = "https://regex101.com/?regex=" + encodeURIComponent(text);
    window.open(url, "_blank");
  });

  // Chatty toggle - mutually exclusive with Fossabot
  chattyToggle.addEventListener("click", () => {
    chattyMode = !chattyMode;
    if (chattyMode) {
      fossabotMode = "standard";
      fossabotToggle.classList.remove("active");
      fossabotModeLabel.textContent = "";
      fossabotMenu.classList.remove("open");
      arrow.classList.remove("down");
    }
    chattyToggle.classList.toggle("active", chattyMode);
    updateDisplay();
  });

  // Fossabot toggle and dropdown
  fossabotToggle.addEventListener("click", () => {
    // open menu
    fossabotMenu.classList.toggle("open");
    arrow.classList.toggle("down");
    // turning on Fossabot should turn Chatty off
    if (!fossabotMenu.classList.contains("open")) {
      // if menu closed nothing else
    } else {
      chattyMode = false;
      chattyToggle.classList.remove("active");
      updateDisplay();
    }
  });

  // dropdown click handlers
  fossabotMenu.querySelectorAll("div").forEach(item => {
    item.addEventListener("click", () => {
      const mode = item.getAttribute("data-mode");
      fossabotMode = mode;
      // if standard then dont color box
      if (mode === "standard") {
        fossabotToggle.classList.remove("active");
        fossabotModeLabel.textContent = "";
      } else {
        fossabotToggle.classList.add("active");
        fossabotModeLabel.textContent = mode;
      }
      // menu close
      fossabotMenu.classList.remove("open");
      arrow.classList.remove("down");
      // selecting fossabot disables chatty
      chattyMode = false;
      chattyToggle.classList.remove("active");
      updateDisplay();
    });
  });

  // Load approved suggestions live from Firestore
  function loadApproved(){
    onSnapshot(collection(db, "regex_approved"), (snapshot) => {
      suggestionsList.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "suggestion-item";
        // show 'regex' if field named regex, otherwise check display/raw
        div.textContent = data.regex ?? data.display ?? data.raw ?? "";
        suggestionsList.appendChild(div);
      });
    });
  }

  // init
  updateDisplay();
  loadApproved();
  </script>
</body>
</html>
